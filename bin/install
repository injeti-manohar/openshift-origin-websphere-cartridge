#!/bin/bash -e
echo ''
echo '######################################################################'
echo '# INSTALL                                                            #'
echo '######################################################################'
echo ''
source $OPENSHIFT_CARTRIDGE_SDK_BASH

case "$1" in
  -v|--version)
    version="$2"
esac

echo "$version" > "$OPENSHIFT_WEBSPHERE_DIR/env/OPENSHIFT_WEBSPHERE_VERSION"

echo 'Generating username and password'

servername="server1"
username="admin"
password=$(generate_password)

echo "$username" > ${OPENSHIFT_WEBSPHERE_DIR}/env/OPENSHIFT_WEBSPHERE_ADMIN_USERNAME
echo "$password" > ${OPENSHIFT_WEBSPHERE_DIR}/env/OPENSHIFT_WEBSPHERE_ADMIN_PASSWORD

client_result ""
client_result "Websphere version: ${version} created.  Please make note of these Administrative User credentials:"
client_result ""
client_result "       Username: $username"
client_result "       Password: $password"
client_result ""
client_result ""

echo "${OPENSHIFT_DATA_DIR}/profile" > ${OPENSHIFT_WEBSPHERE_DIR}/env/OPENSHIFT_WEBSPHERE_PROFILE
echo "$servername" > ${OPENSHIFT_WEBSPHERE_DIR}/env/OPENSHIFT_WEBSPHERE_SERVERNAME

# Create softlink to WebSphere binary installation
ln -s ${OPENSHIFT_WEBSPHERE_INSTALL_LOCATION} ${OPENSHIFT_WEBSPHERE_DIR}/install

# Create WebSphere Profile
log_manageprofiles_result=`${OPENSHIFT_WEBSPHERE_DIR}/install/bin/manageprofiles.sh -create -profileName ${OPENSHIFT_GEAR_UUID} -profilePath ${OPENSHIFT_DATA_DIR}/profile -templatePath ${OPENSHIFT_WEBSPHERE_INSTALL_LOCATION}/profileTemplates/default/ -enableAdminSecurity true -adminUserName ${username} -adminPassword ${password} -hostName ${OPENSHIFT_GEAR_DNS} -applyPerfTuningSetting development -cellName OpenShiftCell -nodeName OpenShiftNode01`
log_manageprofiles_abouthisprofile=`cat ${OPENSHIFT_DATA_DIR}/profile/logs/AboutThisProfile.txt`

# Customize WebSphere Profile
${OPENSHIFT_DATA_DIR}/profile/bin/wsadmin.sh -lang jython -conntype NONE -f ${OPENSHIFT_WEBSPHERE_DIR}/usr/wsadmin_customizeWebSphereProfile.py

# Create Hot Deployment Dir
mkdir ${OPENSHIFT_DATA_DIR}/profile/monitoredDeployableApps

# Setup logging
ln -s ${OPENSHIFT_DATA_DIR}/profile/logs/${servername}/SystemOut.log ${OPENSHIFT_LOG_DIR}/SystemOut.log
ln -s ${OPENSHIFT_DATA_DIR}/profile/logs/${servername}/SystemErr.log ${OPENSHIFT_LOG_DIR}/SystemErr.log

client_result "$log_manageprofiles_result"
client_result ""
client_result ""
client_result "$log_manageprofiles_abouthisprofile"

echo ''
echo '######################################################################'
echo '######################################################################'
echo ''